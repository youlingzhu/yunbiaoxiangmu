#{extends 'LatoWebDelegate/main.html' /}

#{set title:title /}


<div class="main product_publish">
	<div class="main_title main_title_w product_publish_title">
		<a href="javascript:;" class="list_back" onclick="history.go(-1)">
			<img src="@{'/public/images/vector_header.png'}" >
		</a>
		<h3>发布产品</h3>
	</div>
<!-- <a href="@{LatoWebDelegate.getIndexForm()}" class="list_back">   <a href="javascript:;" class="list_back list_back_a" onClick="history.back(-1)"> -->
	<form id="defaultForm" method="post" action="@{LatoWebDelegate.putForm('productPublish')}">
		<input type="hidden" name="lato_objectId" id="lato_objectId" value="" />
		<input type="hidden" name="lato_product_code" id="lato_product_code" value="${prodctCode}" />
		<input type="hidden" name="query_product_name" id="query_product_name" value="" />
		<input type="hidden" name="lato_app_id" id="lato_app_id" value="" />
		<input type="hidden" name="lato_app_name" id="lato_app_name" value="" />
		<input type="hidden" name="lato_server_code" id="lato_server_code" value="" />
		<input type="hidden" name="lato_app_global_id" id="lato_app_global_id" value="" />
		<input type="hidden" name="lato_is_open_source" id="lato_is_open_source" value="false" />
		<input type="hidden" name="lato_is_repeated_release" id="lato_is_repeated_release" value="false" />
		<input type="hidden" name="lato_back_code" id="lato_back_code" value="" />

		<div class="main_body product_publish_body">
			<p>基础信息</p>
			<div class="main_left main_left_one">
				<div class="productNumber">
					<div class="body_name body_menu1 clearfix form-group body_name_one">
						<div class="clearfix">
							<label class="menu_name">模板库名称</label>
							<input type="text" value="${prodctName}" id="lato_product_name" name="lato_product_name"
								placeholder="请输入您的产品名称" class="users_text" />
						</div>
					</div>

					<div class="body_name body_menu1 clearfix form-group body_name_two">
					<div class="clearfix">
						<label class="menu_name">模板库版本编号</label>
						<input type="text" value="" id="lato_product_version" name="lato_product_version"
							placeholder="请输入版本号" class="users_text" />
					</div>
				</div>
			</div>
			<div class="penSource">
				<div class="body_pay body_menu1 clearfix body_pay_one">
					<label class="menu_name">是否开源</label>
					<ul class="radio_type">
						<li id="radio_is_open" class="radio_pub is_open">
							<i></i>
							<span>是</span>
						</li> 
						<li id="radio_is_close" class="radio_pub is_open select_radio">
							<i></i>
							<span>否</span>
						</li>
					</ul>
					<img src="@{'/public/images/1.0/150.png'}"
						data-html="true" data-toggle="tooltip" data-placement="right"
						title="开源: 允许修改模板 <br>不开源: 不允许修改模板，但不允许发布给其他人">
				</div>

				<div class="body_pay body_menu1 clearfix body_pay_two">
					<label class="menu_name">支持二次发布</label>
					<ul class="radio_type">
						<li id="radio_is_repeated_release" class="radio_pub is_release">
							<i></i>
							<span>是</span>
						</li> 
						<li id="radio_is_repeated_release_close" class="radio_pub is_release select_radio">
							<i></i>
							<span>否</span>
						</li>
					</ul>
					<img id="imgScrend" src="@{'/public/images/1.0/150.png'}"
						data-toggle="tooltip" data-placement="right" title="">
					<div id="pScrend">
						<p class="p1"></p>
						<p class="p2">支持二次发布:完全开放模板库，可以自由修改，可以自由发布给其他人</p>		
					</p>	
				   	</div>
				
			</div>

		</div>

		<div class="main_left main_right">
			<div class="body_name body_menu1 clearfix main_right_one">
				<label class="menu_name">模板库描述</label>
				<textarea class="product_description" name="lato_product_desc" id="lato_product_desc"></textarea>
			</div>

			<div class="body_pay body_menu1 clearfix form-group main_right_two" id="backUp_form">
				<div class="clearfix">
					<label class="menu_name">备份名称</label>
					<input class="users_text" name="lato_back_name" id="lato_back_name"></input>
					<a class="version_number" data-toggle="modal" href="javascript:query_app_back();">选择模板库备份</a>
				</div>
			</div>

			<div class=" body_menu1 clearfix main_right_three">
				<div class="body_name body_menu1 clearfix form-group main_right_four">
					<label class="menu_name">备份描述</label>
					<textarea  class="product_description" name="lato_back_desc" id="lato_back_desc"></textarea>
				</div>
				<hr />
				<div class="openSource">
					<!-- font-size: 16px;font-weight:700;color: #373F4A;margin-top:20px;text-indent:30px;float: left -->
					<span class="span1">是否公开发售</span>
					<div class="formSource" id="formSource">
							<label class="label1">
								<input type="hidden" name="lato_is_private" id="lato_is_private" value="false">
								<input id="publicInputTure" checked="checked" type="radio" name="radio"  />
								<span></span>
								<b>是</b>
							</label>
							<label class="label2">
								<input  id="publicInputFalse" type="radio" name="radio" />
								<span></span>
								<b>否</b>
							</label>
						<img id="imgScrendfashou" src="@{'/public/images/1.0/150.png'}" data-toggle="tooltip" data-placement="right">
						<div id="pScrendfashou">
							<p class="p1"></p>
							<p class="p2">
								公开：可供其他人购买使用<br />
								不公开：仅当前账号使用
							</p>
						</div>
				</div>


				<div id="productPriceDom">
					<div class="body_name body_menu1 clearfix form-group productPriceDom_one">
						<div class="clearfix">
							<label class="menu_name">本地首并发价</label>
							<input type="text" value="" id="lato_local_product_first_limit"
								name="lato_local_product_first_limit" placeholder="请输入本地首并发价" class="users_text" />
						</div>
					</div>

					<div class="body_pay body_menu1 clearfix form-group  productPriceDom_two">
						<div class="clearfix">
							<label class="menu_name">本地续并发价</label>
							<input type="text" value="" id="lato_product_continue_limit"
								name="lato_product_continue_limit" placeholder="请输入本地续并发价" class="users_text" />
						</div>
					</div>

					<div class="body_pay body_menu1 clearfix form-group  productPriceDom_three">
						<div class="clearfix">
							<label class="menu_name">云端销售价</label>
							<input type="text" value="" id="lato_cloud_product_price" name="lato_cloud_product_price"
								placeholder="请输入云端销售价" class="users_text" />
						</div>
					</div>

					<div class="body_pay body_menu1 clearfix form-group  productPriceDom_four" style="margin-top:20px;">
						<div class="clearfix">
							<label class="menu_name">最低购买时长</label>
							<input type="text" value="" id="lato_minimum_purchase_month"
								name="lato_minimum_purchase_month" placeholder="请输入最低购买时长" class="users_text" />
						</div>
					</div>
				</div>
				<div class="button productPriceDom_btn">
					<button type="submit" class="version_number product_sure2" data-dismiss="modal">确认发布</button>
                </div>
			</div>

		</div>





</div>
</div>

<!-- :form -->



<div class="modal fade" id="loca_app_back_model" tabindex="-1" role="dialog" aria-labelledby="loca_app_back_model"
	aria-hidden="true">
	<div class="modal-dialog" style="width:60%">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
				</button>
				<h4 class="modal-title" id="loca_app_back_model">
					<span id="errorTypeSpan">请选择相应的备份</span>
				</h4>
			</div>

			<div class="modal-body">

				<table data-toggle="table" data-url="@{LatoWebDelegate.queryAccountAppBack()}" id="app_back_table"
					name="localServer" data-click-to-select="true" data-search="true" data-pagination="true"
					data-select-item-name="radioName">
					<thead>
						<tr>
							<th data-field="lato_state" data-radio="true" data-formatter="stateFormatter"></th>
							<th data-field="备份名称" data-halign="center" data-align="left">备份名称</th>
							<th data-field="备份描述" data-halign="center" data-align="left">备份描述</th>
							<th data-field="备份时间" data-halign="center" data-align="left">备份时间</th>
							<th data-field="应用名称" data-halign="center" data-align="left">应用名称</th>
							<th data-field="应用ID" data-halign="center" data-align="left">应用ID</th>
							<th data-field="服务器编号" data-halign="center" data-align="left">服务器编号</th>
						</tr>
					</thead>
				</table>


			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-lato" data-dismiss="modal">取消
				</button>
				<button type="button" class="btn btn-primary" onclick="selectAppBack()">确认</button>
			</div>
		</div>
	</div>
</div>


<div class="modal fade" id="loca_prodct_list_model" tabindex="-1" role="dialog" aria-labelledby="loca_prodct_list_model"
	aria-hidden="true">
	<div class="modal-dialog" style="width:40%">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
				</button>
				<h4 class="modal-title" id="loca_prodct_list_model">
					<span id="errorTypeSpan">选择指定产品进行升级</span>
				</h4>
			</div>

			<div class="modal-body">

				<table data-toggle="table" data-url="@{LatoWebDelegate.queryProductList()}" id="prodct_list_table"
					name="localServer" data-click-to-select="true" data-search="true" data-pagination="true"
					data-select-item-name="radioName">
					<thead>
						<tr>
							<th data-field="lato_state" data-radio="true" data-formatter="stateFormatter"></th>
							<th data-field="产品编号" data-halign="center" data-align="left">产品编号</th>
							<th data-field="产品名称" data-halign="center" data-align="left">产品名称</th>
						</tr>
					</thead>
				</table>

			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-lato"
							   data-dismiss="modal">取消
				</button>

				<button type="button" class="btn btn-primary" onclick="selectProdct()" id="load-data">
					选择完毕
				</button>

			</div>
		</div>




	</div>




</div>




<script type="text/javascript">
	function updateButtonState() {

		$('#defaultForm').bootstrapValidator('disableSubmitButtons', false);

	}
	$("#select_is_open_source :radio").click(function () {

		var value1 = $(this).val();
		$("#lato_is_open_source").val(value1);
	});

	function query_app_back() {
		
		$('#loca_app_back_model').modal({
			keyboard: true
		})
	}



	function query_prodct_list() {
		$('#loca_prodct_list_model').modal({
			keyboard: true
		})
	}
  

	function clearProduct() {
		$("#lato_product_code").val('');
		$("#lato_product_name").val('');
		$("#query_product_name").val('');

	}

   
	
	// selectClick()

    // function selectClick(){
    //     console.log(window.localStorage.getItem('clickData'))
	// 		var row=JSON.parse(window.localStorage.getItem('clickData'));
	// 		console.log(row);
	// 	    $("#lato_app_id").val(row.应用ID);
	// 		$("#lato_app_name").val(row.应用名称);
	// 		$("#lato_server_code").val(row.服务器编号);
	// 		$("#lato_app_global_id").val(row.应用唯一标识);
	// 		$("#lato_back_code").val(row.编号);
	// 		$("#lato_back_name").val(row.备份名称);
	// 		$("#lato_back_desc").val(row.备份描述);
	// 		$('#defaultForm').data('bootstrapValidator').updateStatus('lato_back_name', 'NOT_VALIDATED')
	// 			.validateField('lato_back_name');
	// 			window.localStorage.setItem('clickData',{})
	// }
	
	var url=window.location.search.slice(1);
	    

	
	function selectClick(){
		
		if(url.indexOf('click')!=-1){
		   url=url.split('&');
		   var a= url[0].split('=')[1];
		   var b= url[1].split('=')[1];         
		 
		    $.get('@{LatoWebApiDelegate.getTemplateLibInfoByCode}?code='+b+'&appCode='+a,function(data){
				var row=JSON.parse(data);
				console.log(row);
				$("#lato_app_id").val(row.应用ID);
				$("#lato_app_name").val(row.应用名称);
				$("#lato_server_code").val(row.服务器编号);
				$("#lato_app_global_id").val(row.应用唯一标识);
				$("#lato_back_code").val(row.编号);
				$("#lato_back_name").val(row.备份名称);
				$("#lato_back_desc").val(row.备份描述);
				//模态框隐藏
				$('#loca_app_back_model').modal("hide");
			$('#defaultForm').data('bootstrapValidator').updateStatus('lato_back_name', 'NOT_VALIDATED')
				.validateField('lato_back_name');
		})
		}
		
		
		

	}

	selectClick();

	function selectAppBack() {

		var ids = $.map($('#app_back_table').bootstrapTable('getSelections'), function (row) {
           // console.log(row)
			$("#lato_app_id").val(row.应用ID);
			$("#lato_app_name").val(row.应用名称);
			$("#lato_server_code").val(row.服务器编号);
			$("#lato_app_global_id").val(row.应用唯一标识);
			$("#lato_back_code").val(row.编号);
			$("#lato_back_name").val(row.备份名称);
			$("#lato_back_desc").val(row.备份描述);
			//模态框隐藏
			$('#loca_app_back_model').modal("hide");


			$('#defaultForm').data('bootstrapValidator').updateStatus('lato_back_name', 'NOT_VALIDATED')
				.validateField('lato_back_name');


		});


	}

	function selectProdct() {

		var ids = $.map($('#prodct_list_table').bootstrapTable('getSelections'), function (row) {
         //  console.log(row)

			$("#lato_product_code").val(row.产品编号);
			$("#lato_product_name").val(row.产品名称);
			$("#query_product_name").val(row.产品名称);
			$("#lato_is_open_source").val(row.是否开源);

			//模态框隐藏
			$('#loca_prodct_list_model').modal("hide");

			$('#defaultForm').data('bootstrapValidator').updateStatus('lato_product_name', 'NOT_VALIDATED')
				.validateField('lato_product_name');

		});


	}



	$('#defaultForm')
		.bootstrapValidator({
			message: 'This value is not valid',
			feedbackIcons: {
				invalid: 'glyphicon glyphicon-remove',
				validating: 'glyphicon glyphicon-refresh'
			},
			fields: {
				'lato_local_product_first_limit': {
					validators: {
						notEmpty: {
							message: '本地首并发价不允许为空...'
						},
						integer: {
							message: '只允许输入整数'
						}
					}
				},
				'lato_product_continue_limit': {
					validators: {
						notEmpty: {
							message: '本地续费不允许为空...'
						},
						integer: {
							message: '只允许输入整数'
						}
					}
				},
				'lato_cloud_product_price': {
					validators: {
						notEmpty: {
							message: '云端销售价不允许为空...'
						},
						integer: {
							message: '只允许输入整数'
						}
					}
				},
				'lato_minimum_purchase_month': {
					validators: {
						notEmpty: {
							message: '最低购买时长不允许为空...'
						},
						integer: {
							message: '只允许输入整数'
						}
					}
				},
				'lato_product_name': {

					validators: {
						notEmpty: {
							message: '产品名称不能为空...'
						}
					}
				},
				'lato_product_version': {
					validators: {
						notEmpty: {
							message: '版本号不允许为空'
						}
					}
				},
				'lato_back_name': {
					validators: {
						notEmpty: {
							message: '需要选择指定的备份才能发布版本'
						}
					}
				}
			}
		})
		.on('error.field.bv', function (e, data) {
			//console.log('error.field.bv -->', data.element);
		})
		.on('success.field.bv', function (e, data) {
			//console.log('success.field.bv -->', data.element);
		}).on('success.form.bv', function (e) {
			e.preventDefault();

			var params = $("form").serialize();
			$.ajax({
				url: "@{LatoWebDelegate.putForm('productPublish')}",
				type: 'POST',
				dataType: 'json',
				data: params,
				success: function (data) {
					if (null != data.errorCode && data.errorCode.length > 0) {
						showErrorModel("发布产品出现错误", data.errorMsg);
						$("#defaultForm").data('bootstrapValidator').resetForm();
					} else {
						location.href = data.url;
					}
				},
				beforeSend: function (xhr) {
					//checkIsEversheetWeb(xhr);
				},
				error: function (XMLHttpRequest, textStatus, errorThrown) {
					var text = decodeURIComponent(XMLHttpRequest.responseText.replace(/\+/g, '%20'));
					var text1 = text.replace(/\r\n|\n|\r/g, '');
					var va11 = decodeURI(text1);
					var val2 = "发布产品出现错误";
					var dataObj = eval("(" + va11 + ")");

					showErrorModel(val2, dataObj.message);
					$("#defaultForm").data('bootstrapValidator').resetForm();
				}
			});

		})
		.on('added.field.bv', function (e, data) {
			//console.log('Added element -->', data.field, data.element);
		})
		.on('removed.field.bv', function (e, data) {
			//console.log('Removed element -->', data.field, data.element);
		});



	$(".is_open").click(function () {
		$(".is_open").removeClass("select_radio");
		$(this).addClass("select_radio");
		if (this.id == "radio_is_open") {
			$("#lato_is_open_source").val("true");
		} else {
			$("#lato_is_open_source").val("false");
		}
	});

	$(".is_release").click(function () {
		$(".is_release").removeClass("select_radio");
		$(this).addClass("select_radio");
		if (this.id == "radio_is_repeated_release") {
			$("#lato_is_repeated_release").val("true");
		} else {
			$("#lato_is_repeated_release").val("false");
		}

	});



	$(document).ready(function () {

		$(function () {
			$("[data-toggle='tooltip']").tooltip();
		});
		$("#lato_is_open_source").val("false");
		$("#lato_is_repeated_release").val("false");

		$('#sub-item-5').addClass('in');

	});




	var formSource = document.getElementById('formSource');
	var aSpanformSource = formSource.getElementsByTagName('span');
	var aInputformSource = formSource.getElementsByTagName('input');
	var productPriceDom = document.getElementById('productPriceDom');
	productPriceDom.style.display = 'block';

	function isCheckedtrue(that) {
		//console.log(that.checked,'542');
		$('#lato_is_private').val(false);
		//console.log($('#lato_is_private').)
		if (that.checked) {
			//productPriceDom.style.display = 'none';
			productPriceDom.style.display = 'block'
		}
	}

	function isCheckedfalse(that) {
		//console.log(that.checked,'551');
		$('#lato_is_private').val(true);
		if (that.checked) {
			productPriceDom.style.display = 'none';
			//productPriceDom.style.display = 'block'
		}
	}
	
	//  onchange="isCheckedtrue(this)"  onchange="isCheckedfalse(this)"  publicInputTure publicInputFalse 


	$('#publicInputTure').on('change',function(){
		
		$('#lato_is_private').val(false);
		if (this.checked) {
			productPriceDom.style.display = 'block'
		}
		//alert($('#lato_is_private').val());
	})

	$('#publicInputFalse').on('change',function(){
		
		$('#lato_is_private').val(true);
		if (this.checked) {
			productPriceDom.style.display = 'none'
		}
		//alert($('#lato_is_private').val());
	})

	  

	$('#imgScrend').mouseover(function(){
		$('#pScrend').show();
	})
	$('#imgScrend').mouseout(function(){
		$('#pScrend').hide();
	})

	$('#pScrendfashou').hide()

    $('#imgScrendfashou').mouseover(function(){
	
		$('#pScrendfashou').show();
	})

	$('#imgScrendfashou').mouseout(function(){
		$('#pScrendfashou').hide();
	})

    




</script>


<style>
  
  .has-error{
	  position: relative;
  }
   
  .has-error .help-block{
	  position: absolute;
	  top: 27px;
	  left: 3px;
  }
  
  #backUp_form .help-block{
	top: 30px;
  }
  
  .menu_name {
	color: rgba(55, 63, 74, 0.8);
  }

  .users_text {
    padding-left: 4px;
}


.version_number:hover {
    background:rgb(89,210,120);
}
.version_number:active{
	border: none!important;
	outline: none!important;
	border: 1px solid transparent!important;
}
.product_sure2{
	width: 130px;
	overflow: hidden;
	height: 40px;
	background: #43BD68;
	border-radius: 4px;
	border: none;
	font-style: normal;
	font-weight: normal;
	font-size: 14px;
	text-align: center;
	margin-top: 20px;
	color: #FFFFFF;
}
       




</style>